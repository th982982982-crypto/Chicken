// ==================================================
// APP SCRIPT CHO CHICKEN MANAGER PRO (FINAL v2)
// ==================================================

function doGet(e) {
  const type = e.parameter.type || 'transactions';
  
  return handleResponse(() => {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // --- LẤY DANH SÁCH DANH MỤC ---
    if (type === 'categories') {
      const sheet = getOrCreateSheet(ss, 'Categories');
      const lastRow = sheet.getLastRow();
      if (lastRow <= 1) {
         return []; 
      }
      // Lấy cột A, bỏ header
      const data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
      const categories = data.flat().filter(function(cell) { return cell !== ""; });
      return categories;
    }
    
    // --- LẤY DANH SÁCH USER ---
    if (type === 'users') {
      const sheet = getOrCreateSheet(ss, 'Users');
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return [];
      return data.slice(1).map(row => ({
        username: String(row[0]),
        password: String(row[1]),
        role: String(row[2])
      })).filter(u => u.username);
    }

    // --- LẤY GIAO DỊCH (MẶC ĐỊNH) ---
    const sheet = getOrCreateSheet(ss, 'Transactions');
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return [];

    const transactions = data.slice(1).map(row => ({
      id: String(row[0]),
      date: formatDate(row[1]), 
      type: row[2],
      category: row[3],
      amount: Number(row[4]),
      note: row[5],
      timestamp: Number(row[6]),
      quantity: Number(row[7] || 1),    
      unitPrice: Number(row[8] || row[4]) 
    })).filter(t => t.id && t.amount);

    // Sắp xếp mới nhất lên đầu
    return transactions.sort((a, b) => b.timestamp - a.timestamp);
  });
}

function doPost(e) {
  return handleResponse(() => {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const body = JSON.parse(e.postData.contents);
    const action = body.action || 'create';

    // --- TẠO GIAO DỊCH MỚI ---
    if (action === 'create') {
      const sheet = getOrCreateSheet(ss, 'Transactions');
      sheet.appendRow([
        body.data.id,
        body.data.date,
        body.data.type,
        body.data.category,
        body.data.amount,
        body.data.note,
        body.data.timestamp,
        body.data.quantity, 
        body.data.unitPrice 
      ]);
      return { status: 'success' };
    }
    
    // --- KẾT SỔ (CLOSE LEDGER) ---
    // Di chuyển dữ liệu hiện tại sang sheet Archive và làm trống sheet chính
    if (action === 'close_ledger') {
      const batchName = body.batchName || ('Batch_' + formatDate(new Date()));
      const sourceSheet = getOrCreateSheet(ss, 'Transactions');
      const targetSheetName = 'Archive_' + batchName;
      
      // Kiểm tra xem tên đã tồn tại chưa
      if (ss.getSheetByName(targetSheetName)) {
        return { status: 'error', message: 'Tên sổ này đã tồn tại, vui lòng chọn tên khác.' };
      }

      const lastRow = sourceSheet.getLastRow();
      if (lastRow <= 1) {
         return { status: 'error', message: 'Không có dữ liệu để kết sổ.' };
      }

      // Tạo sheet lưu trữ mới
      const targetSheet = ss.insertSheet(targetSheetName);
      
      // Copy toàn bộ dữ liệu sang sheet mới (bao gồm header)
      const range = sourceSheet.getDataRange();
      range.copyTo(targetSheet.getRange(1, 1));
      
      // Xóa dữ liệu ở sheet cũ (chừa lại dòng header - dòng 1)
      // deleteRows(rowIndex, numRows) -> rowIndex bắt đầu từ 1. Header là 1. Dữ liệu bắt đầu từ 2.
      sourceSheet.deleteRows(2, lastRow - 1);
      
      return { status: 'success', message: 'Đã kết sổ và lưu trữ thành công.' };
    }

    // --- TẠO DANH MỤC MỚI ---
    if (action === 'create_category') {
      const sheet = getOrCreateSheet(ss, 'Categories');
      const newCat = String(body.category).trim();
      
      if (!newCat) return { status: 'error', message: 'Empty category' };

      const data = sheet.getDataRange().getValues();
      const exists = data.some(row => String(row[0]).toLowerCase() === newCat.toLowerCase());
      
      if (!exists) {
        sheet.appendRow([newCat, new Date()]);
        return { status: 'success', message: 'Category added' };
      }
      return { status: 'success', message: 'Category already exists' };
    }

    // --- TẠO USER MỚI ---
    if (action === 'create_user') {
      const sheet = getOrCreateSheet(ss, 'Users');
      const u = body.user;
      const data = sheet.getDataRange().getValues();
      const exists = data.some(row => String(row[0]) === u.username);
      if (exists) return { status: 'error', message: 'User exists' };
      
      sheet.appendRow([u.username, u.password, u.role, new Date()]);
      return { status: 'success' };
    }
    
    // --- XÓA GIAO DỊCH ---
    if (action === 'delete') {
      const sheet = getOrCreateSheet(ss, 'Transactions');
      deleteRowByCol(sheet, 0, String(body.id));
      return { status: 'success' };
    }

    // --- XÓA USER ---
    if (action === 'delete_user') {
      const sheet = getOrCreateSheet(ss, 'Users');
      deleteRowByCol(sheet, 0, String(body.username));
      return { status: 'success' };
    }
  });
}

// Hàm xóa dòng dựa trên giá trị cột
function deleteRowByCol(sheet, colIndex, value) {
  const data = sheet.getDataRange().getValues();
  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][colIndex]) === value) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}

// Hàm lấy hoặc tạo Sheet nếu chưa có
function getOrCreateSheet(ss, name) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    if (name === 'Transactions') {
      sheet.appendRow(['ID', 'Date', 'Type', 'Category', 'Total Amount', 'Note', 'Timestamp', 'Quantity', 'Unit Price']);
    } else if (name === 'Categories') {
      sheet.appendRow(['Category Name', 'Created Date']);
      const defaults = ['Bán Gà', 'Bán Trứng', 'Thức ăn', 'Thuốc men', 'Gà giống', 'Dụng cụ', 'Khác'];
      defaults.forEach(d => sheet.appendRow([d, new Date()]));
    } else if (name === 'Users') {
      sheet.appendRow(['Username', 'Password', 'Role', 'CreatedDate']);
      sheet.appendRow(['admin', '123', 'admin', new Date()]);
    }
  }
  return sheet;
}

// Hàm trả về JSON chuẩn
function handleResponse(callback) {
  try {
    const result = callback();
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Hàm định dạng ngày tháng an toàn
function formatDate(date) {
  if (!date) return '';
  if (typeof date.getMonth === 'function') {
     var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();
    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;
    return [year, month, day].join('-');
  }
  return String(date);
}